sudo: required
language: java
jdk:
- openjdk8
services:
- docker
cache:
  directories:
  - $HOME/.m2
env:
  global:
  # AWS_ACCESS_KEY_ID
  - secure: "YzQnc3E9+b/7MLMItI+f2IUPLR7ETtmMnKF6dbQUTLjhJTkoTUucIxiW47MCtUaWuybr16s74mFQhh/+f5qp2nYYU37Dlvl9gPVg8Qag+aHky507Chcnyzs09Zjci5KZ0sl4pLn+wd3OILfyjlCpsDU0oR452BGAg3BLM/uiKzY="
  # AWS_SECRET_ACCESS_KEY
  - secure: "ovb3MIPfJNGZL/dVnwCDUJHtOO677orm8nRn1Gz6A4wipVMjJ/zIRYhwf5brvcEnyOZPI9iKLESrkfqtckJ5CSUXnUuqYAHD7l9un5n5FBcmMv9jbfWcY54a3aqqvHgDRScEKZE4XR7DhHuK++n5zRC9eEEzBBYEhw08+fk+iQI="

install:
- git clone https://github.com/Opetushallitus/ci-tools.git
- source ci-tools/common/setup-tools.sh
- export ARTIFACT_NAME="oppija-raamit"

script:
- mvn clean install -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER}

- mv -v target/oppija-raamit-*.jar $DOCKER_BUILD_DIR/artifact/oppija-raamit.jar

- export BASE_IMAGE="baseimage-fatjar-openjdk8:master"
- ./ci-tools/common/pull-image.sh
- ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
  provider: script
  script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
  on:
    all_branches: true
